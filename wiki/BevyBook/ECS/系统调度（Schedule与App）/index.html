
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 8.0.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>BevyBook：系统调度（Schedule & App） - LHM's Blog</title>

  
    <meta name="description" content="系统调度（Schedule &amp; App）概述学习目标：  理解 Schedule 的概念和作用 掌握如何控制系统执行顺序 了解自定义 Schedule 的创建方法 理解 App 的生命周期和运行条件  前置知识要求：  核心编程框架（ECS） 系统（Systems） 资源（Resources） Rust 基础语法  核心概念什么是 Schedule？Schedule 控制系统执行策略和每个">
<meta property="og:type" content="website">
<meta property="og:title" content="系统调度（Schedule &amp; App）">
<meta property="og:url" content="https://luohaomin.github.io/Luo-Haomin/wiki/BevyBook/ECS/%E7%B3%BB%E7%BB%9F%E8%B0%83%E5%BA%A6%EF%BC%88Schedule%E4%B8%8EApp%EF%BC%89/">
<meta property="og:site_name" content="LHM&#39;s Blog">
<meta property="og:description" content="系统调度（Schedule &amp; App）概述学习目标：  理解 Schedule 的概念和作用 掌握如何控制系统执行顺序 了解自定义 Schedule 的创建方法 理解 App 的生命周期和运行条件  前置知识要求：  核心编程框架（ECS） 系统（Systems） 资源（Resources） Rust 基础语法  核心概念什么是 Schedule？Schedule 控制系统执行策略和每个">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="solar:star-ring-bold-duotone">
<meta property="article:published_time" content="2025-11-08T03:18:59.494Z">
<meta property="article:modified_time" content="2025-11-08T03:18:59.494Z">
<meta property="article:author" content="LuoHaomin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="solar:star-ring-bold-duotone">
  
  
  
  

  <!-- feed -->
  
    <link rel="alternate" href="/Luo-Haomin/atom.xml" title="LHM's Blog" type="application/atom+xml">
  

  <link rel="stylesheet" href="/Luo-Haomin/css/main.css?v=1.33.1">


  
    <link rel="shortcut icon" href="/Luo-Haomin/image/Logo.jpg">
  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Website","@id":"https://luohaomin.github.io/Luo-Haomin/wiki/BevyBook/ECS/%E7%B3%BB%E7%BB%9F%E8%B0%83%E5%BA%A6%EF%BC%88Schedule%E4%B8%8EApp%EF%BC%89/","author":{"@type":"Person","name":"LuoHaomin","sameAs":[],"image":"solar:star-ring-bold-duotone"},"name":"系统调度（Schedule & App）","description":"系统调度（Schedule &amp; App）概述学习目标：\n\n理解 Schedule 的概念和作用\n掌握如何控制系统执行顺序\n了解自定义 Schedule 的创建方法\n理解 App 的生命周期和运行条件\n\n前置知识要求：\n\n核心编程框架（ECS）\n系统（Systems）\n资源（Resources）\nRust 基础语法\n\n核心概念什么是 Schedule？Schedule 控制系统执行策略...","url":"https://luohaomin.github.io/Luo-Haomin/wiki/BevyBook/ECS/%E7%B3%BB%E7%BB%9F%E8%B0%83%E5%BA%A6%EF%BC%88Schedule%E4%B8%8EApp%EF%BC%89/"}</script>
  
</head>
<body>



<div class="l_body content" id="start" layout="page" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2779789.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/Luo-Haomin/wiki/BevyBook/README"><div class="main">BevyBook</div><div class="sub cap">从零开始掌握 Bevy 游戏开发</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="博客" href="/Luo-Haomin/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item active" title="文档" href="/Luo-Haomin/wiki/" style="color:#00FF7F"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M4 4.69434V18.6943C4 20.3512 5.34315 21.6943 7 21.6943H17C18.6569 21.6943 20 20.3512 20 18.6943V8.69434C20 7.03748 18.6569 5.69434 17 5.69434H5C4.44772 5.69434 4 5.24662 4 4.69434ZM7.25 11.6943C7.25 11.2801 7.58579 10.9443 8 10.9443H16C16.4142 10.9443 16.75 11.2801 16.75 11.6943C16.75 12.1085 16.4142 12.4443 16 12.4443H8C7.58579 12.4443 7.25 12.1085 7.25 11.6943ZM7.25 15.1943C7.25 14.7801 7.58579 14.4443 8 14.4443H13.5C13.9142 14.4443 14.25 14.7801 14.25 15.1943C14.25 15.6085 13.9142 15.9443 13.5 15.9443H8C7.58579 15.9443 7.25 15.6085 7.25 15.1943Z" fill="currentColor"></path><path opacity="0.5" d="M18 4.00038V5.86504C17.6872 5.75449 17.3506 5.69434 17 5.69434H5C4.44772 5.69434 4 5.24662 4 4.69434V4.62329C4 4.09027 4.39193 3.63837 4.91959 3.56299L15.7172 2.02048C16.922 1.84835 18 2.78328 18 4.00038Z" fill="currentColor"></path></svg></a><a class="nav-item" title="笔记" href="/Luo-Haomin/notebooks/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="关于" href="/Luo-Haomin/about/" style="color:#FF1493"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.2915 4.78559C4.78799 5.52306 3.03694 7.79713 3.00057 10.4163C3 10.4574 3 10.5036 3 10.596V12.9192C3.10197 12.9191 3.2056 12.9398 3.30479 12.9835C8.84065 15.4273 15.1597 15.4273 20.6956 12.9835C20.7947 12.9398 20.8982 12.9191 21 12.9192V10.596C21 10.5036 21 10.4574 20.9994 10.4163C20.9631 7.79714 19.212 5.52309 16.7085 4.7856C16.4308 4.69458 15.5892 4.53187 15.2032 4.46189C13.0832 4.10174 10.9169 4.10173 8.79689 4.46188C8.39226 4.53846 7.52471 4.71042 7.2915 4.78559ZM10 11.9259C9.58579 11.9259 9.25 12.2594 9.25 12.6708C9.25 13.0823 9.58579 13.4158 10 13.4158H14C14.4142 13.4158 14.75 13.0823 14.75 12.6708C14.75 12.2594 14.4142 11.9259 14 11.9259H10Z" fill="currentColor"></path><path opacity="0.5" d="M8.87313 3.99175C9.17888 3.11649 10.0165 2.48989 10.9995 2.48989H12.9995C13.9826 2.48989 14.8202 3.11649 15.1259 3.99175C15.1714 4.12188 15.1935 4.27205 15.2027 4.46183C15.5887 4.53181 16.4303 4.69453 16.7081 4.78555V4.72453C16.7081 4.38601 16.6965 3.94261 16.5431 3.50336C16.0344 2.04714 14.641 1 12.9995 1H10.9995C9.35804 1 7.96471 2.04714 7.45601 3.50336C7.30256 3.94261 7.29102 4.38601 7.29102 4.72453V4.78553C7.52422 4.71037 8.39178 4.53841 8.7964 4.46182C8.80554 4.27205 8.82767 4.12188 8.87313 3.99175Z" fill="currentColor"></path><path opacity="0.5" d="M21 14.4767C20.1 14.8586 19.1814 15.1807 18.2502 15.443V16.6438C18.2502 17.0552 17.9144 17.3888 17.5002 17.3888C17.086 17.3888 16.7502 17.0552 16.7502 16.6438V15.8117C12.1726 16.7753 7.36827 16.3302 3 14.4766V16.0229C3 18.1266 4.47101 19.948 6.53853 20.4043C10.1356 21.1983 13.8644 21.1983 17.4615 20.4043C19.529 19.948 21 18.1266 21 16.0229V14.4767Z" fill="currentColor"></path></svg></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/BevyBook/" placeholder="在 BevyBook 中搜索..."></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<widget class="widget-wrapper doc-tree post-list"><div class="widget-header dis-select"><span class="name">基础</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/README/#start"><span class="toc-text">Bevy 完整教程</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/INDEX/"><span class="toc-text">Bevy 教程完整索引</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/LEARNING_PATH/"><span class="toc-text">学习路径指南</span></a></div><div class="widget-header dis-select"><span class="name">Foundation（基础）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/Foundation/README/"><span class="toc-text">Foundation（基础）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Foundation/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"><span class="toc-text">快速入门</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Foundation/Bevy%E2%80%94%E2%80%94Rust%E6%A1%86%E6%9E%B6/"><span class="toc-text">Bevy——Rust框架</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Foundation/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E5%9F%BA%E7%A1%80/"><span class="toc-text">游戏引擎基础</span></a></div><div class="widget-header dis-select"><span class="name">ECS（实体组件系统）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/README/"><span class="toc-text">ECS（实体组件系统）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6%EF%BC%88ECS%EF%BC%89/"><span class="toc-text">核心编程框架（ECS）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E7%BB%84%E4%BB%B6%EF%BC%88Components%EF%BC%89/"><span class="toc-text">组件（Components）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E5%AE%9E%E4%BD%93%EF%BC%88Entities%EF%BC%89/"><span class="toc-text">实体（Entities）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E7%B3%BB%E7%BB%9F%EF%BC%88Systems%EF%BC%89/"><span class="toc-text">系统（Systems）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E6%9F%A5%E8%AF%A2%EF%BC%88Queries%EF%BC%89/"><span class="toc-text">查询（Queries）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E8%B5%84%E6%BA%90%EF%BC%88Resources%EF%BC%89/"><span class="toc-text">资源（Resources）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E5%91%BD%E4%BB%A4%EF%BC%88Commands%EF%BC%89/"><span class="toc-text">命令（Commands）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E6%97%B6%E9%97%B4%E7%B3%BB%E7%BB%9F%EF%BC%88Time%EF%BC%89/"><span class="toc-text">时间系统（Time）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%EF%BC%88State%EF%BC%89/"><span class="toc-text">状态管理（State）</span></a><a class="link active" href="/Luo-Haomin/wiki/BevyBook/ECS/%E7%B3%BB%E7%BB%9F%E8%B0%83%E5%BA%A6%EF%BC%88Schedule%E4%B8%8EApp%EF%BC%89/"><span class="toc-text">系统调度（Schedule & App）</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/ECS/ECS%E8%BF%9B%E9%98%B6/"><span class="toc-text">ECS 进阶</span></a></div><div class="widget-header dis-select"><span class="name">Assets（资源管理）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/Assets/README/"><span class="toc-text">Assets（资源管理）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Assets/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"><span class="toc-text">资源管理</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Assets/%E5%9C%BA%E6%99%AF%E7%B3%BB%E7%BB%9F%EF%BC%88Scene%EF%BC%89/"><span class="toc-text">场景系统（Scene）</span></a></div><div class="widget-header dis-select"><span class="name">Input（输入处理）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/Input/README/"><span class="toc-text">Input（输入处理）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Input/input%E5%9F%BA%E7%A1%80/"><span class="toc-text">input基础</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Input/%E8%BE%93%E5%85%A5%E5%A4%84%E7%90%86/"><span class="toc-text">输入处理</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Input/%E6%8B%BE%E5%8F%96%E7%B3%BB%E7%BB%9F%EF%BC%88Picking%EF%BC%89/"><span class="toc-text">拾取系统（Picking）</span></a></div><div class="widget-header dis-select"><span class="name">Animation（动画）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/Animation/README/"><span class="toc-text">Animation（动画系统）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Animation/%E5%8A%A8%E7%94%BB%E5%9F%BA%E7%A1%80/"><span class="toc-text">动画基础</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Animation/%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/"><span class="toc-text">动画进阶</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Animation/UI%E5%8A%A8%E7%94%BB/"><span class="toc-text">UI 动画</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Animation/%E5%8F%98%E5%BD%A2%E7%9B%AE%E6%A0%87/"><span class="toc-text">变形目标（Morph Targets）</span></a></div><div class="widget-header dis-select"><span class="name">2D Graphics（2D图形）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/2D_Graphics/README/"><span class="toc-text">2D Graphics（2D 图形）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/2D_Graphics/2D%E5%9F%BA%E7%A1%80/"><span class="toc-text">2D 基础</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/2D_Graphics/2D%E5%BC%80%E5%8F%91/"><span class="toc-text">2D开发</span></a></div><div class="widget-header dis-select"><span class="name">3D Graphics（3D图形）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/3D_Graphics/README/"><span class="toc-text">3D Graphics（3D 图形）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/3D_Graphics/3D%E5%BC%80%E5%8F%91/"><span class="toc-text">3D开发</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/3D_Graphics/%E7%9B%B8%E6%9C%BA%E7%B3%BB%E7%BB%9F%EF%BC%88Camera%EF%BC%89/"><span class="toc-text">相机系统（Camera）</span></a></div><div class="widget-header dis-select"><span class="name">UI & Audio（界面与音频）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/README/"><span class="toc-text">UI & Audio & Window（界面、音频与窗口）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/%E7%AA%97%E5%8F%A3/"><span class="toc-text">窗口管理</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/UI/"><span class="toc-text">用户界面（UI）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/%E9%9F%B3%E9%A2%91/"><span class="toc-text">音频系统</span></a></div><div class="widget-header dis-select"><span class="name">Architecture（架构设计）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/Architecture/README/"><span class="toc-text">Architecture（架构设计）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Architecture/%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/"><span class="toc-text">代码组织</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Architecture/%E9%80%BB%E8%BE%91-%E6%B8%B2%E6%9F%93%E5%88%86%E7%A6%BB/"><span class="toc-text">逻辑-渲染分离</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Architecture/plugin%E7%B3%BB%E7%BB%9F/"><span class="toc-text">插件系统</span></a></div><div class="widget-header dis-select"><span class="name">Advanced（高级主题）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/Advanced/README/"><span class="toc-text">Advanced（高级主题）</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Advanced/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><span class="toc-text">性能优化</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Advanced/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93/"><span class="toc-text">自定义渲染</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Advanced/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="toc-text">网络编程</span></a><a class="link" href="/Luo-Haomin/wiki/BevyBook/Advanced/%E6%8B%86%E8%A7%A3%E5%AD%A6%E4%B9%A0/"><span class="toc-text">拆解学习</span></a></div><div class="widget-header dis-select"><span class="name">Examples（示例项目）</span></div><div class="widget-body fs14"><a class="link" href="/Luo-Haomin/wiki/BevyBook/Examples/README/"><span class="toc-text">Examples（示例项目）</span></a></div></widget>

<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/%E9%9F%B3%E9%A2%91/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>音频系统</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/%E7%AA%97%E5%8F%A3/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>窗口管理</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/UI/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>用户界面（UI）</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/UI_Audio_Window/README/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>UI & Audio & Window（界面、音频与窗口）</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/Input/%E8%BE%93%E5%85%A5%E5%A4%84%E7%90%86/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>输入处理</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/Input/%E6%8B%BE%E5%8F%96%E7%B3%BB%E7%BB%9F%EF%BC%88Picking%EF%BC%89/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>拾取系统（Picking）</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/Input/README/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>Input（输入处理）</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/Foundation/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E5%9F%BA%E7%A1%80/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>游戏引擎基础</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/Foundation/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>快速入门</span></a><a class="item title" href="/Luo-Haomin/wiki/BevyBook/Foundation/README/"><span class="title"><strong>BevyBook</strong><span class="dot"></span>Foundation（基础）</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/Luo-Haomin/Luo-Haomin/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/Luo-Haomin/wiki/">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/Luo-Haomin/wiki/BevyBook/README/">BevyBook</a></div>
<div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2025-11-08T03:18:59.494Z">2025-11-08</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>系统调度（Schedule & App）</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="系统调度（Schedule-App）"><a href="#系统调度（Schedule-App）" class="headerlink" title="系统调度（Schedule &amp; App）"></a>系统调度（Schedule &amp; App）</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>学习目标</strong>：</p>
<ul>
<li>理解 Schedule 的概念和作用</li>
<li>掌握如何控制系统执行顺序</li>
<li>了解自定义 Schedule 的创建方法</li>
<li>理解 App 的生命周期和运行条件</li>
</ul>
<p><strong>前置知识要求</strong>：</p>
<ul>
<li>核心编程框架（ECS）</li>
<li>系统（Systems）</li>
<li>资源（Resources）</li>
<li>Rust 基础语法</li>
</ul>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="什么是-Schedule？"><a href="#什么是-Schedule？" class="headerlink" title="什么是 Schedule？"></a>什么是 Schedule？</h3><p>Schedule 控制系统执行策略和每个 tick 内系统的广泛顺序。每个系统都属于一个 Schedule，Schedule 控制系统的执行顺序。</p>
<p><strong>为什么使用 Schedule？</strong></p>
<ol>
<li><strong>执行顺序</strong>：Schedule 控制系统的执行顺序</li>
<li><strong>执行策略</strong>：Schedule 控制系统的执行策略（并行或顺序）</li>
<li><strong>生命周期</strong>：Schedule 控制系统的生命周期（启动、更新、结束等）</li>
</ol>
<h3 id="Schedule-的设计思想"><a href="#Schedule-的设计思想" class="headerlink" title="Schedule 的设计思想"></a>Schedule 的设计思想</h3><p>Schedule 采用数据导向的设计思想，将系统执行顺序和逻辑分离。这种设计使得：</p>
<ul>
<li>系统可以灵活组织</li>
<li>系统执行顺序可以明确控制</li>
<li>系统可以并行执行，提高性能</li>
</ul>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><h3 id="默认-Schedule"><a href="#默认-Schedule" class="headerlink" title="默认 Schedule"></a>默认 Schedule</h3><p>Bevy 提供了多个默认 Schedule，如 <code>Startup</code>、<code>Update</code>、<code>Last</code> 等。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/ecs_guide.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    App::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        <span class="comment">// `Startup` 系统在应用启动时恰好运行一次</span></span><br><span class="line">        <span class="comment">// 这些通常用于应用初始化代码（例如：添加实体和资源）</span></span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(Startup, startup_system)</span><br><span class="line">        <span class="comment">// `Update` 系统每次更新运行一次</span></span><br><span class="line">        <span class="comment">// 这些通常用于&quot;实时应用逻辑&quot;</span></span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(Update, print_message_system)</span><br><span class="line">        <span class="comment">// 还有其他 Schedule，如 `Last`，它在每次运行的末尾运行</span></span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(Last, print_at_end_round)</span><br><span class="line">        .<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li><code>Startup</code>：启动系统，在应用启动时运行一次</li>
<li><code>Update</code>：更新系统，每次更新运行一次</li>
<li><code>Last</code>：最后系统，在每次运行的末尾运行</li>
<li>系统按 Schedule 顺序执行</li>
</ul>
<p><strong>说明</strong>：<br>Bevy 提供了多个默认 Schedule，用于控制系统的执行顺序。<code>Startup</code> 系统在应用启动时运行一次，用于初始化。<code>Update</code> 系统每次更新运行一次，用于游戏逻辑。<code>Last</code> 系统在每次运行的末尾运行，用于清理。</p>
<h3 id="系统执行顺序"><a href="#系统执行顺序" class="headerlink" title="系统执行顺序"></a>系统执行顺序</h3><p>可以通过 <code>.before()</code> 和 <code>.after()</code> 方法控制系统的执行顺序。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/ecs_guide.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统执行顺序</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 每个系统属于一个 `Schedule`，它控制执行策略和每个 tick 内系统的广泛顺序</span></span><br><span class="line"><span class="comment">// `Startup` schedule 保存启动系统，它们在 `Update` 运行之前运行一次</span></span><br><span class="line"><span class="comment">// `Update` 每次应用更新运行一次，通常是一&quot;帧&quot;或一&quot;tick&quot;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 默认情况下，`Schedule` 中的所有系统并行运行，除非它们需要对数据的可变访问</span></span><br><span class="line"><span class="comment">// 这是高效的，但有时顺序很重要</span></span><br><span class="line"><span class="comment">// 例如，我们希望我们的&quot;游戏结束&quot;系统在所有其他系统之后执行</span></span><br><span class="line"><span class="comment">// 以确保我们不会意外地多运行一轮游戏</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 你可以使用 `.before` 或 `.after` 方法强制系统之间的显式顺序</span></span><br><span class="line"><span class="comment">// 系统不会调度，直到它们具有&quot;顺序依赖&quot;的所有系统都已完成</span></span><br><span class="line"><span class="comment">// 还有其他 Schedule，如 `Last`，它在每次运行的末尾运行</span></span><br><span class="line">.<span class="title function_ invoke__">add_systems</span>(Last, print_at_end_round)</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li>默认情况下，系统并行运行</li>
<li>使用 <code>.before()</code> 和 <code>.after()</code> 方法控制顺序</li>
<li>系统不会调度，直到依赖的系统完成</li>
<li>可变访问会阻止并行执行</li>
</ul>
<p><strong>说明</strong>：<br>默认情况下，系统并行运行，除非它们需要对数据的可变访问。使用 <code>.before()</code> 和 <code>.after()</code> 方法可以明确控制系统的执行顺序。系统不会调度，直到它们依赖的所有系统都已完成。</p>
<h3 id="系统集（SystemSet）"><a href="#系统集（SystemSet）" class="headerlink" title="系统集（SystemSet）"></a>系统集（SystemSet）</h3><p>系统集用于组织相关系统，并控制它们的执行顺序。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/ecs_guide.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 一组相关的系统集，用于控制系统顺序</span></span><br><span class="line"><span class="comment">/// 系统可以添加到任意数量的集合中</span></span><br><span class="line"><span class="meta">#[derive(SystemSet, Debug, Hash, PartialEq, Eq, Clone)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">MySystems</span> &#123;</span><br><span class="line">    BeforeRound,</span><br><span class="line">    Round,</span><br><span class="line">    AfterRound,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    App::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        <span class="comment">// 我们也可以创建新的系统集，并相对于其他系统集对它们进行排序</span></span><br><span class="line">        <span class="comment">// 这是我们游戏的执行顺序：</span></span><br><span class="line">        <span class="comment">// &quot;before_round&quot;: new_player_system, new_round_system</span></span><br><span class="line">        <span class="comment">// &quot;round&quot;: print_message_system, score_system</span></span><br><span class="line">        <span class="comment">// &quot;after_round&quot;: score_check_system, game_over_system</span></span><br><span class="line">        .<span class="title function_ invoke__">configure_sets</span>(</span><br><span class="line">            Update,</span><br><span class="line">            <span class="comment">// chain() 将确保集合按列出的顺序运行</span></span><br><span class="line">            (</span><br><span class="line">                MySystems::BeforeRound,</span><br><span class="line">                MySystems::Round,</span><br><span class="line">                MySystems::AfterRound,</span><br><span class="line">            )</span><br><span class="line">                .<span class="title function_ invoke__">chain</span>(),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// add_systems 函数很强大。你可以轻松定义复杂的系统配置！</span></span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(</span><br><span class="line">            Update,</span><br><span class="line">            (</span><br><span class="line">                <span class="comment">// 这些 `BeforeRound` 系统将在 `Round` 系统之前运行，这要归功于链式集合配置</span></span><br><span class="line">                (</span><br><span class="line">                    <span class="comment">// 你也可以链式系统！new_round_system 将首先运行，然后是 new_player_system</span></span><br><span class="line">                    (new_round_system, new_player_system).<span class="title function_ invoke__">chain</span>(),</span><br><span class="line">                    exclusive_player_system,</span><br><span class="line">                )</span><br><span class="line">                    <span class="comment">// 上面元组中的所有系统都将添加到这个集合中</span></span><br><span class="line">                    .<span class="title function_ invoke__">in_set</span>(MySystems::BeforeRound),</span><br><span class="line">                <span class="comment">// 这个 `Round` 系统将在 `BeforeRound` 系统之后运行，这要归功于链式集合配置</span></span><br><span class="line">                score_system.<span class="title function_ invoke__">in_set</span>(MySystems::Round),</span><br><span class="line">                <span class="comment">// 这些 `AfterRound` 系统将在 `Round` 系统之后运行，这要归功于链式集合配置</span></span><br><span class="line">                (</span><br><span class="line">                    score_check_system,</span><br><span class="line">                    <span class="comment">// 除了 chain()，你还可以使用 `before(system)` 和 `after(system)`</span></span><br><span class="line">                    <span class="comment">// 这也适用于集合！</span></span><br><span class="line">                    game_over_system.<span class="title function_ invoke__">after</span>(score_check_system),</span><br><span class="line">                )</span><br><span class="line">                    .<span class="title function_ invoke__">in_set</span>(MySystems::AfterRound),</span><br><span class="line">            ),</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li>使用 <code>SystemSet</code> 组织相关系统</li>
<li>使用 <code>configure_sets()</code> 配置系统集的顺序</li>
<li>使用 <code>.chain()</code> 方法链式系统集</li>
<li>使用 <code>.in_set()</code> 方法将系统添加到系统集</li>
</ul>
<p><strong>说明</strong>：<br>系统集用于组织相关系统，并控制它们的执行顺序。使用 <code>configure_sets()</code> 可以配置系统集的顺序，使用 <code>.chain()</code> 方法可以链式系统集。</p>
<h2 id="进阶用法"><a href="#进阶用法" class="headerlink" title="进阶用法"></a>进阶用法</h2><h3 id="自定义-Schedule"><a href="#自定义-Schedule" class="headerlink" title="自定义 Schedule"></a>自定义 Schedule</h3><p>可以创建自定义 Schedule，用于特定的执行策略。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/custom_schedule.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> bevy::&#123;</span><br><span class="line">    app::MainScheduleOrder,</span><br><span class="line">    ecs::schedule::&#123;ExecutorKind, ScheduleLabel&#125;,</span><br><span class="line">    prelude::*,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(ScheduleLabel, Debug, Hash, PartialEq, Eq, Clone)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SingleThreadedUpdate</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(ScheduleLabel, Debug, Hash, PartialEq, Eq, Clone)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CustomStartup</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">app</span> = App::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个新的 [`Schedule`]</span></span><br><span class="line">    <span class="comment">// 为了演示目的，我们将其配置为使用单线程执行器</span></span><br><span class="line">    <span class="comment">// 这样此 Schedule 中的系统永远不会并行运行</span></span><br><span class="line">    <span class="comment">// 但是，这不是自定义 Schedule 的一般要求</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">custom_update_schedule</span> = Schedule::<span class="title function_ invoke__">new</span>(SingleThreadedUpdate);</span><br><span class="line">    custom_update_schedule.<span class="title function_ invoke__">set_executor_kind</span>(ExecutorKind::SingleThreaded);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 Schedule 添加到应用不会自动运行它</span></span><br><span class="line">    <span class="comment">// 这只是注册 Schedule，以便系统可以使用 `Schedules` 资源查找它</span></span><br><span class="line">    app.<span class="title function_ invoke__">add_schedule</span>(custom_update_schedule);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bevy `App` 有一个 `main_schedule_label` 字段，它配置应用运行器运行哪个 Schedule</span></span><br><span class="line">    <span class="comment">// 默认情况下，这是 `Main`</span></span><br><span class="line">    <span class="comment">// `Main` Schedule 负责运行 Bevy 的主要 Schedule，如 `Update`、`Startup` 或 `Last`</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 我们可以通过修改 `MainScheduleOrder` 资源来配置 `Main` Schedule 运行我们的自定义更新 Schedule</span></span><br><span class="line">    <span class="comment">// 相对于现有的 Schedule</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 注意，我们在 `main` 中直接修改 `MainScheduleOrder`，而不是在启动系统中</span></span><br><span class="line">    <span class="comment">// 原因是 `MainScheduleOrder` 不能从作为 `Main` Schedule 一部分运行的系统修改</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">main_schedule_order</span> = app.<span class="title function_ invoke__">world_mut</span>().resource_mut::&lt;MainScheduleOrder&gt;();</span><br><span class="line">    main_schedule_order.<span class="title function_ invoke__">insert_after</span>(Update, SingleThreadedUpdate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加自定义启动 Schedule 的工作方式类似，但需要使用 `insert_startup_after`</span></span><br><span class="line">    <span class="comment">// 而不是 `insert_after`</span></span><br><span class="line">    app.<span class="title function_ invoke__">add_schedule</span>(Schedule::<span class="title function_ invoke__">new</span>(CustomStartup));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">main_schedule_order</span> = app.<span class="title function_ invoke__">world_mut</span>().resource_mut::&lt;MainScheduleOrder&gt;();</span><br><span class="line">    main_schedule_order.<span class="title function_ invoke__">insert_startup_after</span>(PreStartup, CustomStartup);</span><br><span class="line"></span><br><span class="line">    app.<span class="title function_ invoke__">add_systems</span>(SingleThreadedUpdate, single_threaded_update_system)</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(CustomStartup, custom_startup_system)</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(PreStartup, pre_startup_system)</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(Startup, startup_system)</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(First, first_system)</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(Update, update_system)</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(Last, last_system)</span><br><span class="line">        .<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li>使用 <code>Schedule::new()</code> 创建自定义 Schedule</li>
<li>使用 <code>ScheduleLabel</code> 派生宏定义 Schedule 标签</li>
<li>使用 <code>set_executor_kind()</code> 设置执行器类型</li>
<li>使用 <code>MainScheduleOrder</code> 配置 Schedule 顺序</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>自定义 Schedule 需要添加到应用</li>
<li>需要配置 <code>MainScheduleOrder</code> 来运行自定义 Schedule</li>
<li>可以使用 <code>ExecutorKind::SingleThreaded</code> 创建单线程 Schedule</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>对于需要特定执行策略的系统，使用自定义 Schedule</li>
<li>对于需要单线程执行的系统，使用单线程 Schedule</li>
<li>注意自定义 Schedule 的执行顺序</li>
</ul>
<h3 id="固定时间步（Fixed-Timestep）"><a href="#固定时间步（Fixed-Timestep）" class="headerlink" title="固定时间步（Fixed Timestep）"></a>固定时间步（Fixed Timestep）</h3><p>固定时间步允许系统以固定时间间隔运行，而不是每帧运行。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/fixed_timestep.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> bevy::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    App::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">add_plugins</span>(DefaultPlugins)</span><br><span class="line">        <span class="comment">// 这个系统将每次更新运行一次（它应该匹配你的屏幕刷新率）</span></span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(Update, frame_update)</span><br><span class="line">        <span class="comment">// 将我们的系统添加到固定时间步 Schedule</span></span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(FixedUpdate, fixed_update)</span><br><span class="line">        <span class="comment">// 配置我们的固定时间步 Schedule 每秒运行两次</span></span><br><span class="line">        .<span class="title function_ invoke__">insert_resource</span>(Time::&lt;Fixed&gt;::<span class="title function_ invoke__">from_seconds</span>(<span class="number">0.5</span>))</span><br><span class="line">        .<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">frame_update</span>(<span class="keyword">mut</span> last_time: Local&lt;<span class="type">f32</span>&gt;, time: Res&lt;Time&gt;) &#123;</span><br><span class="line">    <span class="comment">// 默认 `Time` 这里是 `Time&lt;Virtual&gt;`</span></span><br><span class="line">    info!(</span><br><span class="line">        <span class="string">&quot;time since last frame_update: &#123;&#125;&quot;</span>,</span><br><span class="line">        time.<span class="title function_ invoke__">elapsed_secs</span>() - *last_time</span><br><span class="line">    );</span><br><span class="line">    *last_time = time.<span class="title function_ invoke__">elapsed_secs</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fixed_update</span>(<span class="keyword">mut</span> last_time: Local&lt;<span class="type">f32</span>&gt;, time: Res&lt;Time&gt;, fixed_time: Res&lt;Time&lt;Fixed&gt;&gt;) &#123;</span><br><span class="line">    <span class="comment">// 默认 `Time` 这里是 `Time&lt;Fixed&gt;`</span></span><br><span class="line">    info!(</span><br><span class="line">        <span class="string">&quot;time since last fixed_update: &#123;&#125;\n&quot;</span>,</span><br><span class="line">        time.<span class="title function_ invoke__">elapsed_secs</span>() - *last_time</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    info!(<span class="string">&quot;fixed timestep: &#123;&#125;\n&quot;</span>, time.<span class="title function_ invoke__">delta_secs</span>());</span><br><span class="line">    <span class="comment">// 如果我们想看到超步，我们需要专门访问 `Time&lt;Fixed&gt;`</span></span><br><span class="line">    info!(</span><br><span class="line">        <span class="string">&quot;time accrued toward next fixed_update: &#123;&#125;\n&quot;</span>,</span><br><span class="line">        fixed_time.<span class="title function_ invoke__">overstep</span>().<span class="title function_ invoke__">as_secs_f32</span>()</span><br><span class="line">    );</span><br><span class="line">    *last_time = time.<span class="title function_ invoke__">elapsed_secs</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li>使用 <code>FixedUpdate</code> Schedule 运行固定时间步系统</li>
<li>使用 <code>Time::&lt;Fixed&gt;::from_seconds()</code> 配置固定时间步</li>
<li>固定时间步系统以固定时间间隔运行</li>
<li>固定时间步适合物理模拟等需要稳定时间步的场景</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>固定时间步系统以固定时间间隔运行</li>
<li>固定时间步适合物理模拟等需要稳定时间步的场景</li>
<li>注意固定时间步与帧率的区别</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>对于物理模拟等需要稳定时间步的系统，使用固定时间步</li>
<li>对于与帧率相关的系统，使用 <code>Update</code> Schedule</li>
<li>注意固定时间步与帧率的区别</li>
</ul>
<h3 id="运行条件（Run-Conditions）"><a href="#运行条件（Run-Conditions）" class="headerlink" title="运行条件（Run Conditions）"></a>运行条件（Run Conditions）</h3><p>运行条件允许控制系统是否应该运行。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/run_conditions.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> bevy::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    App::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">add_plugins</span>(DefaultPlugins)</span><br><span class="line">        .init_resource::&lt;InputCounter&gt;()</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(</span><br><span class="line">            Update,</span><br><span class="line">            (</span><br><span class="line">                increment_input_counter</span><br><span class="line">                    <span class="comment">// common_conditions 模块有一些有用的运行条件</span></span><br><span class="line">                    <span class="comment">// 用于检查资源和状态</span></span><br><span class="line">                    <span class="comment">// 这些包含在 prelude 中</span></span><br><span class="line">                    .<span class="title function_ invoke__">run_if</span>(resource_exists::&lt;InputCounter&gt;)</span><br><span class="line">                    <span class="comment">// `.or()` 是一个运行条件组合器，只有在第一个条件返回 `false` 时才评估第二个条件</span></span><br><span class="line">                    <span class="comment">// 这种行为称为&quot;短路&quot;，是 Rust 中 `||` 运算符的工作方式（以及大多数 C 系列语言）</span></span><br><span class="line">                    <span class="comment">// 在这种情况下，`has_user_input` 运行条件将被评估，因为 `Unused` 资源尚未初始化</span></span><br><span class="line">                    .<span class="title function_ invoke__">run_if</span>(resource_exists::&lt;Unused&gt;.<span class="title function_ invoke__">or</span>(</span><br><span class="line">                        <span class="comment">// 这是一个自定义运行条件，使用返回 `bool` 的系统定义</span></span><br><span class="line">                        <span class="comment">// 并且具有只读 `SystemParam`</span></span><br><span class="line">                        <span class="comment">// 只有一个运行条件必须返回 `true`，系统才会运行</span></span><br><span class="line">                        has_user_input,</span><br><span class="line">                    )),</span><br><span class="line">                print_input_counter</span><br><span class="line">                    <span class="comment">// `.and()` 是一个运行条件组合器，只有在第一个条件返回 `true` 时才评估第二个条件</span></span><br><span class="line">                    <span class="comment">// 类似于 `&amp;&amp;` 运算符</span></span><br><span class="line">                    <span class="comment">// 在这种情况下，短路行为防止第二个运行条件在 `InputCounter` 资源未初始化时 panic</span></span><br><span class="line">                    .<span class="title function_ invoke__">run_if</span>(resource_exists::&lt;InputCounter&gt;.<span class="title function_ invoke__">and</span>(</span><br><span class="line">                        <span class="comment">// 这是一个闭包形式的自定义运行条件</span></span><br><span class="line">                        <span class="comment">// 这对于不需要重用的小型、简单的运行条件很有用</span></span><br><span class="line">                        <span class="comment">// 所有正常规则仍然适用：所有参数必须是只读的，除了本地参数</span></span><br><span class="line">                        |counter: Res&lt;InputCounter&gt;| counter.<span class="title function_ invoke__">is_changed</span>() &amp;&amp; !counter.<span class="title function_ invoke__">is_added</span>(),</span><br><span class="line">                    )),</span><br><span class="line">                print_time_message</span><br><span class="line">                    <span class="comment">// 这个函数返回一个自定义运行条件，很像 common_conditions 模块</span></span><br><span class="line">                    <span class="comment">// 它只会在 2 秒过去后返回 true</span></span><br><span class="line">                    .<span class="title function_ invoke__">run_if</span>(<span class="title function_ invoke__">time_passed</span>(<span class="number">2.0</span>))</span><br><span class="line">                    <span class="comment">// 你可以使用 common_conditions 模块中的 `not` 条件</span></span><br><span class="line">                    <span class="comment">// 来反转运行条件</span></span><br><span class="line">                    <span class="comment">// 在这种情况下，如果自应用启动以来经过的时间少于 2.5 秒，它将返回 true</span></span><br><span class="line">                    .<span class="title function_ invoke__">run_if</span>(<span class="title function_ invoke__">not</span>(<span class="title function_ invoke__">time_passed</span>(<span class="number">2.5</span>))),</span><br><span class="line">            ),</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 如果任何定义的输入刚刚被按下，则返回 true</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 这是一个自定义运行条件，它可以接受任何正常的系统参数</span></span><br><span class="line"><span class="comment">/// 只要它们是只读的（除了本地参数可以是可变的）</span></span><br><span class="line"><span class="comment">/// 它返回一个 bool，决定系统是否应该运行</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">has_user_input</span>(</span><br><span class="line">    keyboard_input: Res&lt;ButtonInput&lt;KeyCode&gt;&gt;,</span><br><span class="line">    mouse_button_input: Res&lt;ButtonInput&lt;MouseButton&gt;&gt;,</span><br><span class="line">    touch_input: Res&lt;Touches&gt;,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    keyboard_input.<span class="title function_ invoke__">just_pressed</span>(KeyCode::Space)</span><br><span class="line">        || keyboard_input.<span class="title function_ invoke__">just_pressed</span>(KeyCode::Enter)</span><br><span class="line">        || mouse_button_input.<span class="title function_ invoke__">just_pressed</span>(MouseButton::Left)</span><br><span class="line">        || mouse_button_input.<span class="title function_ invoke__">just_pressed</span>(MouseButton::Right)</span><br><span class="line">        || touch_input.<span class="title function_ invoke__">any_just_pressed</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 这是一个返回闭包的函数，可以用作运行条件</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 这很有用，因为你可以重用相同的运行条件，但使用不同的变量</span></span><br><span class="line"><span class="comment">/// 这就是 common_conditions 模块的工作方式</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">time_passed</span>(t: <span class="type">f32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">FnMut</span>(Local&lt;<span class="type">f32</span>&gt;, Res&lt;Time&gt;) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">move</span> |<span class="keyword">mut</span> timer: Local&lt;<span class="type">f32</span>&gt;, time: Res&lt;Time&gt;| &#123;</span><br><span class="line">        <span class="comment">// 计时器计时</span></span><br><span class="line">        *timer += time.<span class="title function_ invoke__">delta_secs</span>();</span><br><span class="line">        <span class="comment">// 如果计时器已经超过时间，返回 true</span></span><br><span class="line">        *timer &gt;= t</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li>使用 <code>.run_if()</code> 方法添加运行条件</li>
<li>使用 <code>.and()</code> 和 <code>.or()</code> 组合运行条件</li>
<li>使用 <code>not()</code> 反转运行条件</li>
<li>运行条件可以是函数或闭包</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>运行条件必须返回 <code>bool</code></li>
<li>运行条件参数必须是只读的（除了本地参数）</li>
<li>只有所有运行条件都返回 <code>true</code> 时，系统才会运行</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>对于条件系统执行，使用运行条件</li>
<li>使用 <code>.and()</code> 和 <code>.or()</code> 组合运行条件</li>
<li>注意运行条件的性能影响</li>
</ul>
<h3 id="系统步进（System-Stepping）"><a href="#系统步进（System-Stepping）" class="headerlink" title="系统步进（System Stepping）"></a>系统步进（System Stepping）</h3><p>系统步进允许逐步执行系统，用于调试。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/system_stepping.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> bevy::&#123;ecs::schedule::Stepping, log::LogPlugin, prelude::*&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">app</span> = App::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    app.<span class="title function_ invoke__">add_plugins</span>(LogPlugin::<span class="title function_ invoke__">default</span>())</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(</span><br><span class="line">            Update,</span><br><span class="line">            (</span><br><span class="line">                update_system_one,</span><br><span class="line">                <span class="comment">// 在这里建立依赖关系以简化下面的描述</span></span><br><span class="line">                update_system_two.<span class="title function_ invoke__">after</span>(update_system_one),</span><br><span class="line">                update_system_three.<span class="title function_ invoke__">after</span>(update_system_two),</span><br><span class="line">                update_system_four,</span><br><span class="line">            ),</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(PreUpdate, pre_update_system);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加 Stepping 资源</span></span><br><span class="line">    app.<span class="title function_ invoke__">insert_resource</span>(Stepping::<span class="title function_ invoke__">new</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 Update Schedule 添加到 Stepping</span></span><br><span class="line">    <span class="comment">// 启用 Stepping</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stepping</span> = app.<span class="title function_ invoke__">world_mut</span>().resource_mut::&lt;Stepping&gt;();</span><br><span class="line">    stepping.<span class="title function_ invoke__">add_schedule</span>(Update).<span class="title function_ invoke__">enable</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 步进一帧</span></span><br><span class="line">    stepping.<span class="title function_ invoke__">step_frame</span>();</span><br><span class="line">    app.<span class="title function_ invoke__">update</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 继续执行剩余系统</span></span><br><span class="line">    stepping.<span class="title function_ invoke__">continue_frame</span>();</span><br><span class="line">    app.<span class="title function_ invoke__">update</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li>使用 <code>Stepping</code> 资源控制系统步进</li>
<li>使用 <code>step_frame()</code> 步进一帧</li>
<li>使用 <code>continue_frame()</code> 继续执行剩余系统</li>
<li>使用 <code>always_run()</code> 和 <code>never_run()</code> 控制特定系统的执行</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>系统步进需要启用 <code>bevy_debug_stepping</code> 特性</li>
<li>系统步进主要用于调试</li>
<li>注意系统步进对性能的影响</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>对于调试，使用系统步进</li>
<li>对于生产环境，禁用系统步进</li>
<li>注意系统步进对性能的影响</li>
</ul>
<h3 id="非确定性系统顺序"><a href="#非确定性系统顺序" class="headerlink" title="非确定性系统顺序"></a>非确定性系统顺序</h3><p>默认情况下，Bevy 系统并行运行，除非明确指定顺序，否则它们的相对顺序是非确定性的。</p>
<p><strong>源代码文件</strong>：<code>bevy/examples/ecs/nondeterministic_system_order.rs</code></p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> bevy::&#123;</span><br><span class="line">    ecs::schedule::&#123;LogLevel, ScheduleBuildSettings&#125;,</span><br><span class="line">    prelude::*,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    App::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        <span class="comment">// 我们可以按每个 Schedule 修改系统执行顺序歧义的报告策略</span></span><br><span class="line">        <span class="comment">// 你必须为每个要检查的 Schedule 执行此操作</span></span><br><span class="line">        <span class="comment">// 在已检查的 Schedule 内执行的子 Schedule 不会继承此修改</span></span><br><span class="line">        .<span class="title function_ invoke__">edit_schedule</span>(Update, |schedule| &#123;</span><br><span class="line">            schedule.<span class="title function_ invoke__">set_build_settings</span>(ScheduleBuildSettings &#123;</span><br><span class="line">                ambiguity_detection: LogLevel::Warn,</span><br><span class="line">                ..<span class="title function_ invoke__">default</span>()</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .init_resource::&lt;A&gt;()</span><br><span class="line">        .init_resource::&lt;B&gt;()</span><br><span class="line">        .<span class="title function_ invoke__">add_systems</span>(</span><br><span class="line">            Update,</span><br><span class="line">            (</span><br><span class="line">                <span class="comment">// 这对系统有歧义顺序</span></span><br><span class="line">                <span class="comment">// 因为它们的数据访问冲突，并且它们之间没有顺序</span></span><br><span class="line">                reads_a,</span><br><span class="line">                writes_a,</span><br><span class="line">                <span class="comment">// 这对系统有冲突的数据访问</span></span><br><span class="line">                <span class="comment">// 但通过显式顺序解决：</span></span><br><span class="line">                <span class="comment">// 这里的 .after 关系意味着我们总是在添加之后加倍</span></span><br><span class="line">                adds_one_to_b,</span><br><span class="line">                doubles_b.<span class="title function_ invoke__">after</span>(adds_one_to_b),</span><br><span class="line">                <span class="comment">// 这个系统与 adds_one_to_b 没有歧义</span></span><br><span class="line">                <span class="comment">// 由于我们的约束创建的传递顺序：</span></span><br><span class="line">                <span class="comment">// 如果 A 在 B 之前，B 在 C 之前，那么 A 必须在 C 之前</span></span><br><span class="line">                reads_b.<span class="title function_ invoke__">after</span>(doubles_b),</span><br><span class="line">                <span class="comment">// 这个系统将与我们的所有写入系统冲突</span></span><br><span class="line">                <span class="comment">// 但我们已经用 adds_one_to_b 静默了它的歧义</span></span><br><span class="line">                <span class="comment">// 这应该只在明显的假阳性情况下完成：</span></span><br><span class="line">                <span class="comment">// 在你的代码中留下注释证明这个决定！</span></span><br><span class="line">                reads_a_and_b.<span class="title function_ invoke__">ambiguous_with</span>(adds_one_to_b),</span><br><span class="line">            ),</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_ invoke__">add_plugins</span>(DefaultPlugins)</span><br><span class="line">        .<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键要点</strong>：</p>
<ul>
<li>默认情况下，系统并行运行，顺序是非确定性的</li>
<li>使用 <code>.after()</code> 和 <code>.before()</code> 明确指定顺序</li>
<li>使用 <code>.ambiguous_with()</code> 静默歧义</li>
<li>使用 <code>ScheduleBuildSettings</code> 配置歧义检测</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>非确定性顺序可能导致微妙的错误</li>
<li>使用 <code>.after()</code> 和 <code>.before()</code> 明确指定顺序</li>
<li>注意歧义检测的性能影响</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>对于有数据访问冲突的系统，明确指定顺序</li>
<li>使用 <code>.ambiguous_with()</code> 静默明显的假阳性</li>
<li>注意歧义检测的性能影响</li>
</ul>
<h2 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h2><h3 id="在游戏开发中的应用场景"><a href="#在游戏开发中的应用场景" class="headerlink" title="在游戏开发中的应用场景"></a>在游戏开发中的应用场景</h3><p>系统调度在游戏开发中有广泛的应用：</p>
<ol>
<li><strong>游戏逻辑</strong>：使用 <code>Update</code> Schedule 运行游戏逻辑</li>
<li><strong>物理模拟</strong>：使用 <code>FixedUpdate</code> Schedule 运行物理模拟</li>
<li><strong>初始化</strong>：使用 <code>Startup</code> Schedule 运行初始化代码</li>
<li><strong>清理</strong>：使用 <code>Last</code> Schedule 运行清理代码</li>
</ol>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p><strong>问题 1</strong>：如何控制系统执行顺序？</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <code>.before()</code> 和 <code>.after()</code> 方法控制顺序</li>
<li>使用系统集组织系统</li>
<li>使用 <code>.chain()</code> 方法链式系统</li>
</ul>
<p><strong>问题 2</strong>：如何创建自定义 Schedule？</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <code>Schedule::new()</code> 创建自定义 Schedule</li>
<li>使用 <code>ScheduleLabel</code> 派生宏定义 Schedule 标签</li>
<li>使用 <code>MainScheduleOrder</code> 配置 Schedule 顺序</li>
</ul>
<p><strong>问题 3</strong>：如何控制系统是否运行？</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <code>.run_if()</code> 方法添加运行条件</li>
<li>使用 <code>.and()</code> 和 <code>.or()</code> 组合运行条件</li>
<li>使用 <code>not()</code> 反转运行条件</li>
</ul>
<h3 id="性能考虑"><a href="#性能考虑" class="headerlink" title="性能考虑"></a>性能考虑</h3><ol>
<li><strong>并行执行</strong>：系统可以并行执行，但可变访问会阻止并行</li>
<li><strong>系统顺序</strong>：明确指定系统顺序可以提高性能</li>
<li><strong>运行条件</strong>：注意运行条件的性能影响</li>
</ol>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><p><strong>相关源代码文件</strong>：</p>
<ul>
<li><code>bevy/examples/ecs/ecs_guide.rs</code> - ECS 完整指南示例（系统调度）</li>
<li><code>bevy/examples/ecs/custom_schedule.rs</code> - 自定义 Schedule 示例</li>
<li><code>bevy/examples/ecs/fixed_timestep.rs</code> - 固定时间步示例</li>
<li><code>bevy/examples/ecs/run_conditions.rs</code> - 运行条件示例</li>
<li><code>bevy/examples/ecs/system_stepping.rs</code> - 系统步进示例</li>
<li><code>bevy/examples/ecs/nondeterministic_system_order.rs</code> - 非确定性系统顺序示例</li>
</ul>
<p><strong>官方文档链接</strong>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.rs/bevy_ecs/latest/bevy_ecs/schedule/index.html">Bevy Schedule 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rs/bevy/latest/bevy/app/struct.App.html">App 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rs/bevy_ecs/latest/bevy_ecs/schedule/trait.SystemSet.html">SystemSet 文档</a></li>
</ul>
<p><strong>进一步学习建议</strong>：</p>
<ul>
<li>学习系统（Systems），了解如何定义系统</li>
<li>学习资源（Resources），了解如何访问资源</li>
<li>学习 ECS 进阶，了解系统调度的高级功能</li>
</ul>
<hr>
<p><strong>索引</strong>：<a href="/Luo-Haomin/wiki/BevyBook/ECS/README">返回上级目录</a></p>
</article>
<div class="article-footer">

</div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/Luo-Haomin/wiki/BevyBook/ECS/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%EF%BC%88State%EF%BC%89/">状态管理（State）</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/Luo-Haomin/wiki/BevyBook/ECS/ECS%E8%BF%9B%E9%98%B6/">ECS 进阶</a></div></section></div>




<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">LuoHaomin</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E5%BA%A6%EF%BC%88Schedule-App%EF%BC%89"><span class="toc-text">系统调度（Schedule &amp; App）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-Schedule%EF%BC%9F"><span class="toc-text">什么是 Schedule？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schedule-%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-text">Schedule 的设计思想</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95"><span class="toc-text">基础用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4-Schedule"><span class="toc-text">默认 Schedule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">系统执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E9%9B%86%EF%BC%88SystemSet%EF%BC%89"><span class="toc-text">系统集（SystemSet）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E7%94%A8%E6%B3%95"><span class="toc-text">进阶用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Schedule"><span class="toc-text">自定义 Schedule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A%E6%97%B6%E9%97%B4%E6%AD%A5%EF%BC%88Fixed-Timestep%EF%BC%89"><span class="toc-text">固定时间步（Fixed Timestep）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%9D%A1%E4%BB%B6%EF%BC%88Run-Conditions%EF%BC%89"><span class="toc-text">运行条件（Run Conditions）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%AD%A5%E8%BF%9B%EF%BC%88System-Stepping%EF%BC%89"><span class="toc-text">系统步进（System Stepping）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%A1%AE%E5%AE%9A%E6%80%A7%E7%B3%BB%E7%BB%9F%E9%A1%BA%E5%BA%8F"><span class="toc-text">非确定性系统顺序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8"><span class="toc-text">实际应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">在游戏开发中的应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E8%80%83%E8%99%91"><span class="toc-text">性能考虑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90"><span class="toc-text">相关资源</span></a></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>回到顶部</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":null,"officialHosts":["localhost"],"encoded":""};
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/Luo-Haomin/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/Luo-Haomin/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/Luo-Haomin/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
