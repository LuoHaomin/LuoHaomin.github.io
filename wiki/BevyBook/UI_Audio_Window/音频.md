# 音频系统## 概述

**学习目标**：
- 理解音频系统的基本概念
- 掌握音频资源的加载和播放
- 学会控制音频播放（播放、暂停、音量、速度）
- 了解 3D 空间音频的使用

**前置知识要求**：
- Bevy 快速入门
- ECS 基础
- 资源管理基础


## 核心概念

### 什么是音频系统？

音频系统是 Bevy 中用于播放音频的功能。Bevy 的音频系统支持背景音乐、音效、3D 空间音频等多种音频类型。

**为什么需要音频系统？**

1. **游戏体验**：音频可以增强游戏体验
2. **反馈**：音频可以提供游戏反馈
3. **氛围**：音频可以营造游戏氛围
4. **沉浸感**：3D 空间音频可以增强沉浸感

### 音频系统的核心组件

Bevy 音频系统包含以下核心组件：

- **AudioPlayer**：音频播放器，用于播放音频
- **AudioSink**：音频接收器，用于控制音频播放
- **PlaybackSettings**：播放设置，用于配置音频播放
- **SpatialListener**：空间监听器，用于 3D 空间音频

## 基础用法

### 加载和播放音频

加载和播放音频资源。

**源代码文件**：`bevy/examples/audio/audio.rs`

**代码示例**：

```rust
use bevy::prelude::*;

fn main() {
    App::new()
        .add_plugins(DefaultPlugins)
        .add_systems(Startup, setup)
        .run();
}

fn setup(asset_server: Res<AssetServer>, mut commands: Commands) {
    commands.spawn(AudioPlayer::new(
        asset_server.load("sounds/Windless Slopes.ogg"),
    ));
}
```

**关键要点**：
- 使用 `AssetServer` 加载音频资源
- 使用 `AudioPlayer` 组件播放音频
- 音频资源支持多种格式（OGG、WAV 等）
- 音频播放是异步的，不会阻塞游戏运行

**说明**：
音频加载和播放是音频系统的基础。通过加载音频资源并创建音频播放器，可以播放背景音乐和音效。

### 音频控制

控制音频播放（播放、暂停、音量、速度）。

**源代码文件**：`bevy/examples/audio/audio_control.rs`

**代码示例**：

```rust
use bevy::prelude::*;

fn setup(mut commands: Commands, asset_server: Res<AssetServer>) {
    commands.spawn((
        AudioPlayer::new(asset_server.load("sounds/Windless Slopes.ogg")),
        MyMusic,
    ));
}

#[derive(Component)]
struct MyMusic;

fn pause(
    keyboard_input: Res<ButtonInput<KeyCode>>,
    music_controller: Query<&AudioSink, With<MyMusic>>,
) {
    let Ok(sink) = music_controller.single() else {
        return;
    };

    if keyboard_input.just_pressed(KeyCode::Space) {
        sink.toggle_playback();
    }
}

fn mute(
    keyboard_input: Res<ButtonInput<KeyCode>>,
    mut music_controller: Query<&mut AudioSink, With<MyMusic>>,
) {
    let Ok(mut sink) = music_controller.single_mut() else {
        return;
    };

    if keyboard_input.just_pressed(KeyCode::KeyM) {
        sink.toggle_mute();
    }
}

fn volume(
    keyboard_input: Res<ButtonInput<KeyCode>>,
    mut music_controller: Query<&mut AudioSink, With<MyMusic>>,
) {
    let Ok(mut sink) = music_controller.single_mut() else {
        return;
    };

    if keyboard_input.pressed(KeyCode::Equal) {
        sink.set_volume((sink.volume() + 0.1).min(1.0));
    }
    if keyboard_input.pressed(KeyCode::Minus) {
        sink.set_volume((sink.volume() - 0.1).max(0.0));
    }
}
```

**关键要点**：
- 使用 `AudioSink` 组件控制音频播放
- 可以使用 `toggle_playback()` 切换播放/暂停
- 可以使用 `toggle_mute()` 切换静音
- 可以使用 `set_volume()` 设置音量
- 可以使用 `set_speed()` 设置播放速度

**说明**：
音频控制允许在运行时动态调整音频播放。这对于创建音频设置界面、响应游戏状态变化等非常有用。

### 3D 空间音频

使用 3D 空间音频创建沉浸式音频体验。

**源代码文件**：`bevy/examples/audio/spatial_audio_3d.rs`

**代码示例**：

```rust
use bevy::prelude::*;

fn setup(
    mut commands: Commands,
    asset_server: Res<AssetServer>,
    mut meshes: ResMut<Assets<Mesh>>,
    mut materials: ResMut<Assets<StandardMaterial>>,
) {
    // 创建音频发射器
    commands.spawn((
        Mesh3d(meshes.add(Sphere::new(0.2).mesh().uv(32, 18))),
        MeshMaterial3d(materials.add(Color::from(BLUE))),
        Transform::from_xyz(0.0, 0.0, 0.0),
        Emitter::default(),
        AudioPlayer::new(asset_server.load("sounds/Windless Slopes.ogg")),
        PlaybackSettings::LOOP.with_spatial(true),
    ));

    // 创建空间监听器
    let listener = SpatialListener::new(4.0); // 4.0 是两耳之间的距离
    commands.spawn((
        Transform::default(),
        Visibility::default(),
        listener,
    ));
}

fn update_listener(
    keyboard: Res<ButtonInput<KeyCode>>,
    mut listener: Query<&mut Transform, With<SpatialListener>>,
) {
    let Ok(mut transform) = listener.single_mut() else {
        return;
    };

    let speed = 2.0;
    if keyboard.pressed(KeyCode::ArrowUp) {
        transform.translation.z -= speed;
    }
    if keyboard.pressed(KeyCode::ArrowDown) {
        transform.translation.z += speed;
    }
    if keyboard.pressed(KeyCode::ArrowLeft) {
        transform.translation.x -= speed;
    }
    if keyboard.pressed(KeyCode::ArrowRight) {
        transform.translation.x += speed;
    }
}
```

**关键要点**：
- 使用 `SpatialListener` 组件创建空间监听器
- 使用 `PlaybackSettings::LOOP.with_spatial(true)` 启用空间音频
- 空间监听器的位置影响音频的感知位置
- 音频发射器的位置影响音频的来源位置

**说明**：
3D 空间音频可以创建沉浸式的音频体验。通过设置音频发射器和监听器的位置，可以模拟真实的声音传播效果。

## 进阶用法

### 音频播放设置

配置音频播放设置。

**关键信息**：
- 可以使用 `PlaybackSettings` 配置播放设置
- 可以设置循环播放、音量、速度等
- 可以启用空间音频
- 可以设置播放延迟

**说明**：
音频播放设置允许精细控制音频播放行为。这对于创建各种音频效果非常有用。

### 音频轨道

管理多个音频轨道。

**源代码文件**：`bevy/examples/audio/soundtrack.rs`

**关键信息**：
- 可以创建多个音频轨道
- 可以在不同轨道之间切换
- 可以同时播放多个轨道
- 可以控制每个轨道的音量

**说明**：
音频轨道允许管理复杂的音频场景。例如，可以创建背景音乐轨道、音效轨道等。

## 实际应用

### 在游戏开发中的应用场景

音频系统在游戏开发中有广泛的应用：

1. **背景音乐**：播放游戏背景音乐
2. **音效**：播放游戏音效，如脚步声、爆炸声等
3. **3D 音频**：创建沉浸式的 3D 音频体验
4. **音频反馈**：提供游戏反馈，如按钮点击声等

### 常见问题

**问题 1**：如何循环播放音频？

**解决方案**：使用 `PlaybackSettings::LOOP` 设置循环播放。

**问题 2**：如何同时播放多个音频？

**解决方案**：创建多个 `AudioPlayer` 实体，每个实体播放不同的音频。

**问题 3**：如何实现 3D 空间音频？

**解决方案**：使用 `SpatialListener` 和 `PlaybackSettings::LOOP.with_spatial(true)` 启用空间音频。

### 性能考虑

1. **音频数量**：尽量减少同时播放的音频数量
2. **音频格式**：选择合适的音频格式以平衡质量和文件大小
3. **音频压缩**：使用压缩音频格式以减少内存使用
4. **空间音频**：只在需要时启用空间音频以提高性能

## 相关资源

**相关源代码文件**：
- `bevy/examples/audio/audio.rs` - 音频播放示例
- `bevy/examples/audio/audio_control.rs` - 音频控制示例
- `bevy/examples/audio/spatial_audio_3d.rs` - 3D 空间音频示例
- `bevy/examples/audio/soundtrack.rs` - 音频轨道示例

**官方文档链接**：
- [Bevy Audio 官方文档](https://docs.rs/bevy_audio/latest/bevy_audio/)
- [音频示例](https://github.com/bevyengine/bevy/tree/main/examples/audio)

**进一步学习建议**：
- 学习资源管理，了解如何加载和管理音频资源
- 学习输入处理，了解如何通过输入控制音频播放
- 学习 3D 开发，了解如何将 3D 空间音频与 3D 场景结合

---

**索引**：[返回上级目录](/wiki/BevyBook/UI_Audio_Window/)


